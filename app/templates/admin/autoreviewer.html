{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-robot"></i> {{ _('Autoreviewer Management') }}</h1>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> {{ _('Back to Dashboard') }}
                </a>
            </div>
        </div>
    </div>

    <!-- Autoreviewer Info Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-robot"></i> {{ _('Autoreviewer System Info') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>{{ _('System User ID:') }}</strong><br>
                            {{ autoreviewer.id }}
                        </div>
                        <div class="col-sm-6">
                            <strong>{{ _('Name:') }}</strong><br>
                            {{ autoreviewer.name }}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-6">
                            <strong>{{ _('Email:') }}</strong><br>
                            {{ autoreviewer.email }}
                        </div>
                        <div class="col-sm-6">
                            <strong>{{ _('Admin Status:') }}</strong><br>
                            <span class="badge badge-success">{{ _('Yes') if autoreviewer.is_admin else _('No') }}</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <strong>{{ _('Created:') }}</strong><br>
                            {{ autoreviewer.created_at.strftime('%Y-%m-%d %H:%M UTC') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Card -->
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-chart-bar"></i> {{ _('Autoreviewer Statistics') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-primary">{{ stats.total_reviewed }}</h3>
                                <small class="text-muted">{{ _('Total Reviewed') }}</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-danger">{{ stats.total_rejected }}</h3>
                                <small class="text-muted">{{ _('Duplicates Rejected') }}</small>
                            </div>
                        </div>
                    </div>
                    {% if stats.total_reviewed > 0 %}
                    <div class="mt-3">
                        <div class="text-center">
                            <strong>{{ _('Rejection Rate:') }}</strong> 
                            {{ "%.1f"|format((stats.total_rejected / stats.total_reviewed * 100)) }}%
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {{ (stats.total_rejected / stats.total_reviewed * 100) }}%" 
                                 aria-valuenow="{{ stats.total_rejected }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ stats.total_reviewed }}">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-cogs"></i> {{ _('Autoreviewer Actions') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-play"></i> {{ _('Run Batch Processing') }}</h6>
                            <p class="text-muted small">
                                {{ _('Check all pending uploads for duplicates based on MD5 hash.') }}
                            </p>
                            <form method="POST" action="{{ url_for('admin.run_autoreviewer_batch') }}">
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-play"></i> {{ _('Run Duplicate Check') }}
                                </button>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-robot"></i> {{ _('AI Batch Review') }}</h6>
                            <p class="text-muted small">
                                {{ _('Use AI to review all pending uploads for quality and accuracy.') }}
                            </p>
                            <form method="POST" action="{{ url_for('admin.ai_review_batch') }}" id="aiBatchForm">
                                <button type="submit" class="btn btn-info w-100" id="aiBatchBtn">
                                    <i class="fas fa-robot"></i> {{ _('Run AI Review') }}
                                </button>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-info-circle"></i> {{ _('How It Works') }}</h6>
                            <ul class="text-muted small">
                                <li>{{ _('Duplicate check: Compares MD5 hashes') }}</li>
                                <li>{{ _('AI review: Analyzes metadata & content') }}</li>
                                <li>{{ _('Auto-approves or rejects based on criteria') }}</li>
                                <li>{{ _('Sends notification emails to uploaders') }}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Review Progress Card (hidden by default) -->
    <div class="row mb-4" id="progressCard" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-spinner fa-spin"></i> {{ _('AI Review Progress') }}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="progressText">Starting...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 id="progressBar"
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <h4 class="text-success" id="stat-approved">0</h4>
                            <small class="text-muted">{{ _('Approved') }}</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-danger" id="stat-rejected">0</h4>
                            <small class="text-muted">{{ _('Rejected') }}</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-warning" id="stat-updated">0</h4>
                            <small class="text-muted">{{ _('Updated') }}</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-secondary" id="stat-errors">0</h4>
                            <small class="text-muted">{{ _('Errors') }}</small>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-list"></i> {{ _('Live Log') }}</h6>
                        </div>
                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;" id="liveLog">
                            <div class="text-muted">{{ _('Waiting for AI review to start...') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Rejections -->
    {% if stats.duplicate_uploads %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-times-circle"></i> {{ _('Recent Duplicate Rejections') }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{{ _('Upload ID') }}</th>
                                    <th>{{ _('Filename') }}</th>
                                    <th>{{ _('Device') }}</th>
                                    <th>{{ _('Uploader') }}</th>
                                    <th>{{ _('Rejected Date') }}</th>
                                    <th>{{ _('Reason') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for upload in stats.duplicate_uploads %}
                                <tr>
                                    <td>{{ upload.id }}</td>
                                    <td>
                                        <a href="{{ url_for('admin.view_upload', upload_id=upload.id) }}">
                                            {{ upload.original_filename }}
                                        </a>
                                    </td>
                                    <td>{{ upload.device_manufacturer }} {{ upload.device_model }}</td>
                                    <td>{{ upload.uploader_name }}</td>
                                    <td>{{ upload.reviewed_at }}</td>
                                    <td>
                                        <small class="text-muted">
                                            {{ upload.rejection_reason[:100] }}{% if upload.rejection_reason and upload.rejection_reason|length > 100 %}...{% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- SocketIO CDN -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
// Auto-refresh stats every 30 seconds
setInterval(function() {
    fetch('{{ url_for("admin.autoreviewer_stats_api") }}')
        .then(response => response.json())
        .then(data => {
            // Update stats if the page structure supports it
            console.log('Autoreviewer stats:', data);
        })
        .catch(error => console.error('Error fetching stats:', error));
}, 30000);

// SocketIO connection for AI review progress
let socket = null;

function initSocketIO() {
    if (socket && socket.connected) {
        console.log('Socket already connected');
        return;
    }

    // Connect to the /autoreviewer namespace with websocket transport preferred
    socket = io('/autoreviewer', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000,
        pingTimeout: 60000,
        pingInterval: 25000
    });
    
    // Keep-alive mechanism to prevent Cloudflare from closing the connection
    var keepAliveInterval = setInterval(function() {
        if (socket && socket.connected) {
            socket.emit('ping');
        }
    }, 30000); // Send ping every 30 seconds
    
    socket.on('connect', function() {
        console.log('Connected to AI review progress updates');
        addLogEntry('Connected to progress server', 'success');
    });
    
    socket.on('connect_error', (error) => {
        console.error('Socket connection error:', error);
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from AI review progress updates');
        addLogEntry('Disconnected from progress server', 'warning');
    });
    
    socket.on('ai_review_progress', function(data) {
        console.log('Progress update:', data);
        handleProgressUpdate(data);
    });
    
    socket.on('error', function(error) {
        console.error('Socket error:', error);
        addLogEntry('Error: ' + error.message, 'danger');
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        clearInterval(keepAliveInterval);
        if (socket) {
            socket.disconnect();
        }
    });
}

function handleProgressUpdate(data) {
    const status = data.status;
    
    // Show progress card if hidden
    const progressCard = document.getElementById('progressCard');
    if (progressCard.style.display === 'none') {
        progressCard.style.display = 'block';
        progressCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    if (status === 'started') {
        // Reset everything
        resetProgressDisplay();
        updateProgressBar(0, data.total || 0);
        document.getElementById('progressText').textContent = data.message || 'Starting AI review...';
        addLogEntry(data.message || 'Starting AI review...', 'info');
        
    } else if (status === 'processing') {
        // Update progress bar
        const processed = data.processed || 0;
        const total = data.total || 0;
        updateProgressBar(processed, total);
        
        // Show current file being processed
        const upload = data.current_upload;
        if (upload) {
            const msg = `[${processed + 1}/${total}] Processing: ${upload.filename} (ID: ${upload.id})`;
            document.getElementById('progressText').textContent = msg;
            addLogEntry(msg, 'primary');
        }
        
    } else if (status === 'completed_item') {
        // Update statistics
        if (data.stats) {
            document.getElementById('stat-approved').textContent = data.stats.approved || 0;
            document.getElementById('stat-rejected').textContent = data.stats.rejected || 0;
            document.getElementById('stat-updated').textContent = data.stats.updated || 0;
            document.getElementById('stat-errors').textContent = data.stats.errors || 0;
        }
        
        // Show result
        const upload = data.current_upload;
        const action = data.action;
        if (upload && action) {
            let logType = 'secondary';
            let actionText = action;
            
            if (action === 'approved') {
                logType = 'success';
                actionText = '✓ APPROVED';
            } else if (action === 'rejected') {
                logType = 'danger';
                actionText = '✗ REJECTED';
            } else if (action === 'updated') {
                logType = 'warning';
                actionText = '⟳ UPDATED';
            } else if (action === 'error') {
                logType = 'danger';
                actionText = '⚠ ERROR';
            }
            
            const msg = `${actionText}: ${upload.filename}`;
            const detail = data.message || '';
            addLogEntry(msg + (detail ? ` - ${detail}` : ''), logType);
        }
        
    } else if (status === 'finished') {
        // Final summary
        const stats = data.stats || {};
        const total = stats.total || 0;
        updateProgressBar(total, total);
        document.getElementById('progressText').textContent = 'AI Review Complete!';
        
        const summary = `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
BATCH REVIEW COMPLETE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Total Processed: ${total}
✓ Approved: ${stats.approved || 0}
✗ Rejected: ${stats.rejected || 0}
⟳ Updated: ${stats.updated || 0}
⚠ Errors: ${stats.errors || 0}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
        
        addLogEntry(summary, 'success');
        
        // Re-enable button
        const btn = document.getElementById('aiBatchBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-robot"></i> {{ _("Run AI Review") }}';
        }
        
        // Auto-reload page after 3 seconds to refresh stats
        setTimeout(function() {
            window.location.reload();
        }, 3000);
        
    } else if (status === 'error') {
        // Error occurred
        document.getElementById('progressText').textContent = 'Error during AI review';
        addLogEntry('ERROR: ' + (data.message || 'Unknown error occurred'), 'danger');
        
        // Re-enable button
        const btn = document.getElementById('aiBatchBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-robot"></i> {{ _("Run AI Review") }}';
        }
    }
}

function updateProgressBar(current, total) {
    if (total === 0) {
        document.getElementById('progressPercent').textContent = '0%';
        document.getElementById('progressBar').style.width = '0%';
        return;
    }
    
    const percent = Math.round((current / total) * 100);
    document.getElementById('progressPercent').textContent = percent + '%';
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', current);
    document.getElementById('progressBar').setAttribute('aria-valuemax', total);
}

function resetProgressDisplay() {
    document.getElementById('liveLog').innerHTML = '';
    document.getElementById('stat-approved').textContent = '0';
    document.getElementById('stat-rejected').textContent = '0';
    document.getElementById('stat-updated').textContent = '0';
    document.getElementById('stat-errors').textContent = '0';
    updateProgressBar(0, 0);
}

function addLogEntry(message, type = 'secondary') {
    const log = document.getElementById('liveLog');
    const entry = document.createElement('div');
    entry.className = 'mb-1 p-1 border-left border-' + type + ' pl-2';
    
    const timestamp = new Date().toLocaleTimeString();
    const isMultiline = message.includes('\n');
    
    if (isMultiline) {
        entry.innerHTML = '<pre class="mb-0" style="white-space: pre; font-family: monospace;">' + 
                         escapeHtml(message) + '</pre>';
    } else {
        entry.innerHTML = '<span class="text-muted">[' + timestamp + ']</span> ' + 
                         escapeHtml(message);
    }
    
    log.appendChild(entry);
    
    // Auto-scroll to bottom
    log.scrollTop = log.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Intercept AI batch form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('aiBatchForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('Are you sure you want to run AI review on all pending uploads? The AI may approve, reject, or update uploads.')) {
                return false;
            }
            
            // Disable button and show loading
            const btn = document.getElementById('aiBatchBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ _("Starting...") }}';
            
            // Initialize socket if not already connected
            if (!socket || !socket.connected) {
                initSocketIO();
            }
            
            // Show progress card
            document.getElementById('progressCard').style.display = 'block';
            resetProgressDisplay();
            addLogEntry('Initiating AI batch review...', 'info');
            
            // Submit the form via fetch
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'started') {
                    addLogEntry('AI review started successfully', 'success');
                } else if (data.status === 'error') {
                    addLogEntry('Error: ' + data.message, 'danger');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-robot"></i> {{ _("Run AI Review") }}';
                } else {
                    addLogEntry('Server response: ' + (data.message || 'Unknown response'), 'warning');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-robot"></i> {{ _("Run AI Review") }}';
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                addLogEntry('Failed to start AI review: ' + error.message, 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot"></i> {{ _("Run AI Review") }}';
            });
            
            return false;
        });
    }
    
    // Initialize socket on page load
    initSocketIO();
});
</script>
{% endblock %}
