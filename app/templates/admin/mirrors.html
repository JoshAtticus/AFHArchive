{% extends "base.html" %}

{% block title %}{{ _('Mirror Management') }} - {{ _('Admin') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-globe"></i> {{ _('Mirror Management') }}</h2>
    <div>
        <a href="{{ url_for('admin.pairing_codes') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-key"></i> {{ _('Pairing Codes') }}
        </a>
        <a href="{{ url_for('admin.server_tools') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> {{ _('Back to Server Tools') }}
        </a>
    </div>
</div>

<!-- Create Pairing Code -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> {{ _('Add New Mirror') }}</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-magic"></i>
                    <strong>{{ _('Auto-Registration Enabled!') }}</strong><br>
                    {{ _('Mirrors now register automatically when they start up.') }}
                </div>
                <p class="text-muted">{{ _('To add a new mirror:') }}</p>
                <ol>
                    <li>{{ _('Deploy the mirror script on your server') }}</li>
                    <li>{{ _('Configure the .env file with your main server URL') }}</li>
                    <li>{{ _('Run') }} <code>python mirror.py</code></li>
                    <li>{{ _('Approve the mirror in the "Pending Approval" section below') }}</li>
                </ol>
                
                <hr>
                <details>
                    <summary class="text-muted">{{ _('Legacy Pairing Code Method') }}</summary>
                    <div class="mt-2">
                        <form method="POST" action="{{ url_for('admin.create_pairing_code') }}">
                            <div class="mb-3">
                                <label for="name" class="form-label">{{ _('Mirror Name') }}</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       placeholder="e.g., Frankfurt Germany, San Francisco US">
                            </div>
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-key"></i> {{ _('Generate Pairing Code') }}
                            </button>
                        </form>
                    </div>
                </details>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> {{ _('Mirror Setup Instructions') }}</h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>{{ _('Create a pairing code using the form') }}</li>
                    <li>{{ _('Download and run the mirror script on your server') }}</li>
                    <li>{{ _('Use the pairing code to connect the mirror') }}</li>
                    <li>{{ _('Configure Cloudflare tunnel URL for public access') }}</li>
                </ol>
                <hr>
                <small class="text-muted">
                    <strong>{{ _('Mirror Script:') }}</strong><br>
                    <code>python mirror.py setup</code><br>
                    <code>python mirror.py</code>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Active Mirrors -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-server"></i> {{ _('Active Mirrors') }} ({{ mirrors|length }})</h5>
    </div>
        <div class="card-body">
            <p class="text-muted">{{ _('Mirrors will now automatically register when they start up. No pairing codes needed!') }}</p>
            <ol class="mb-3">
                <li>{{ _('Deploy mirror script on your server') }}: <code>python mirror.py</code></li>
                <li>{{ _('Mirror will auto-register and appear in "Pending Approval" below') }}</li>
                <li>{{ _('Approve the mirror to activate it for downloads') }}</li>
                <li>{{ _('Configure URLs and settings as needed') }}</li>
            </ol>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                {{ _('The old pairing code system is still available for legacy setups.') }}
                <a href="{{ url_for('admin.pairing_codes') }}" class="alert-link">{{ _('Manage pairing codes') }}</a>
            </div>
        </div>
    </div>
</div>

<!-- Pending Mirrors (Need Approval) -->
{% set pending_mirrors = mirrors|selectattr('status', 'equalto', 'pending')|list %}
{% if pending_mirrors %}
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5><i class="fas fa-clock"></i> {{ _('Pending Approval') }} ({{ pending_mirrors|length }})</h5>
        <small>{{ _('These mirrors are waiting for admin approval') }}</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>{{ _('Server Name') }}</th>
                        <th>{{ _('Direct URL') }}</th>
                        <th>{{ _('Registered') }}</th>
                        <th>{{ _('Last Seen') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mirror in pending_mirrors %}
                    <tr>
                        <td>
                            <strong>{{ mirror.server_name }}</strong>
                            <br><small class="text-muted">ID: {{ mirror.id }}</small>
                        </td>
                        <td>
                            <small class="text-muted">{{ mirror.direct_url }}</small>
                        </td>
                        <td>
                            <small class="text-muted">{{ mirror.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </td>
                        <td>
                            {% if mirror.last_seen %}
                                <small class="text-muted">{{ mirror.last_seen.strftime('%Y-%m-%d %H:%M') }}</small>
                                {% if mirror.is_online %}
                                    <span class="badge bg-success ms-1">{{ _('Online') }}</span>
                                {% else %}
                                    <span class="badge bg-danger ms-1">{{ _('Offline') }}</span>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">{{ _('Never') }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <form method="POST" action="{{ url_for('admin.approve_mirror', mirror_id=mirror.id) }}" 
                                      style="display: inline;">
                                    <button type="submit" class="btn btn-success" 
                                            onclick="return confirm('{{ _('Approve this mirror?') }}')"
                                            title="{{ _('Approve Mirror') }}">
                                        <i class="fas fa-check"></i> {{ _('Approve') }}
                                    </button>
                                </form>
                                <button type="button" class="btn btn-danger" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#rejectModal{{ mirror.id }}"
                                        title="{{ _('Reject Mirror') }}">
                                    <i class="fas fa-times"></i> {{ _('Reject') }}
                                </button>
                                <a href="{{ url_for('admin.mirror_detail', mirror_id=mirror.id) }}" 
                                   class="btn btn-outline-primary" title="{{ _('View Details') }}">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                            
                            <!-- Reject Modal -->
                            <div class="modal fade" id="rejectModal{{ mirror.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ _('Reject Mirror') }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="POST" action="{{ url_for('admin.reject_mirror', mirror_id=mirror.id) }}">
                                            <div class="modal-body">
                                                <p>{{ _('Are you sure you want to reject mirror') }} <strong>{{ mirror.server_name }}</strong>?</p>
                                                <div class="mb-3">
                                                    <label for="reason{{ mirror.id }}" class="form-label">{{ _('Reason (optional)') }}</label>
                                                    <textarea class="form-control" id="reason{{ mirror.id }}" name="reason" 
                                                              rows="3" placeholder="{{ _('Enter rejection reason...') }}"></textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                                                <button type="submit" class="btn btn-danger">{{ _('Reject Mirror') }}</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Active Mirrors -->
{% set active_mirrors = mirrors|rejectattr('status', 'equalto', 'pending')|rejectattr('status', 'equalto', 'rejected')|list %}
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-server"></i> {{ _('Active Mirrors') }} ({{ active_mirrors|length }})</h5>
    </div>
    <div class="card-body">
        {% if active_mirrors %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>{{ _('Name') }}</th>
                        <th>{{ _('Status') }}</th>
                        <th>{{ _('Direct URL') }}</th>
                        <th>{{ _('Cloudflare URL') }}</th>
                        <th>{{ _('Files') }}</th>
                        <th>{{ _('Last Seen') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mirror in active_mirrors %}
                    <tr>
                        <td>
                            <strong>{{ mirror.server_name }}</strong>
                        </td>
                        <td>
                            {% if mirror.status == 'active' %}
                                {% if mirror.is_online %}
                                    <span class="badge bg-success">{{ _('Active & Online') }}</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ _('Active & Offline') }}</span>
                                {% endif %}
                            {% elif mirror.status == 'inactive' %}
                                <span class="badge bg-secondary">{{ _('Inactive') }}</span>
                            {% else %}
                                <span class="badge bg-info">{{ mirror.status|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ mirror.direct_url }}</small>
                        </td>
                        <td>
                            {% if mirror.cloudflare_url %}
                                <a href="{{ mirror.cloudflare_url }}" target="_blank" class="text-decoration-none">
                                    <small>{{ mirror.cloudflare_url }}</small>
                                    <i class="fas fa-external-link-alt fa-xs"></i>
                                </a>
                            {% else %}
                                <small class="text-muted">{{ _('Not configured') }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ mirror.storage_usage_percent }}%" 
                                     aria-valuenow="{{ mirror.storage_usage_percent }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ mirror.current_files }}/{{ mirror.max_files }}
                                </div>
                            </div>
                            <small class="text-muted">{{ "%.1f"|format(mirror.storage_usage_percent) }}% used</small>
                        </td>
                        <td>
                            {% if mirror.last_seen %}
                                <small class="text-muted">{{ mirror.last_seen.strftime('%Y-%m-%d %H:%M') }}</small>
                            {% else %}
                                <small class="text-muted">{{ _('Never') }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('admin.mirror_detail', mirror_id=mirror.id) }}" 
                                   class="btn btn-outline-primary" title="{{ _('View Details') }}">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin.trigger_mirror_sync', mirror_id=mirror.id) }}" 
                                      style="display: inline;">
                                    <button type="submit" class="btn btn-outline-success" 
                                            title="{{ _('Trigger Sync') }}">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </form>
                                <a href="{{ url_for('admin.edit_mirror', mirror_id=mirror.id) }}" 
                                   class="btn btn-outline-secondary" title="{{ _('Edit') }}">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-server fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">{{ _('No mirrors configured') }}</h5>
            <p class="text-muted">{{ _('Create a pairing code to set up your first mirror server.') }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Sync Logs -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-history"></i> {{ _('Recent Sync Activity') }}</h5>
    </div>
    <div class="card-body">
        {% if recent_logs %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{ _('Time') }}</th>
                        <th>{{ _('Mirror') }}</th>
                        <th>{{ _('Action') }}</th>
                        <th>{{ _('Message') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_logs %}
                    <tr>
                        <td><small>{{ log.created_at.strftime('%m-%d %H:%M') }}</small></td>
                        <td><small>{{ log.mirror.name }}</small></td>
                        <td>
                            {% if log.action == 'sync_complete' %}
                                <span class="badge bg-success">{{ log.action }}</span>
                            {% elif log.action == 'sync_error' %}
                                <span class="badge bg-danger">{{ log.action }}</span>
                            {% elif log.action == 'file_added' %}
                                <span class="badge bg-info">{{ log.action }}</span>
                            {% elif log.action == 'file_removed' %}
                                <span class="badge bg-warning">{{ log.action }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ log.action }}</span>
                            {% endif %}
                        </td>
                        <td><small>{{ log.message }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-3">{{ _('No sync activity yet') }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}
